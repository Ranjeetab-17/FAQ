import DEFAULTS from"./defaults";import TEMPLATE from"./template";import render from"./render";import events from"./events";import handlers from"./handlers";import methods from"./methods";import others from"./others";import{BUTTONS,CLASS_CLOSE,CLASS_FADE,CLASS_FIXED,CLASS_FULLSCREEN,CLASS_HIDE,CLASS_INVISIBLE,DATA_ACTION,EVENT_CLICK,EVENT_LOAD,EVENT_READY,NAMESPACE,REGEXP_SPACES,WINDOW}from"./constants";import{addClass,addListener,assign,dispatchEvent,forEach,getResponsiveClass,hyphenate,isFunction,isNumber,isPlainObject,isString,isUndefined,removeListener,setData,setStyle,toggleClass}from"./utilities";const AnotherViewer=WINDOW.Viewer;class Viewer{constructor(e,t={}){if(!e||1!==e.nodeType)throw new Error("The first argument is required and must be an element.");this.element=e,this.options=assign({},DEFAULTS,isPlainObject(t)&&t),this.action=!1,this.fading=!1,this.fulled=!1,this.hiding=!1,this.imageClicked=!1,this.imageData={},this.index=this.options.initialViewIndex,this.isImg=!1,this.isShown=!1,this.length=0,this.played=!1,this.playing=!1,this.pointers={},this.ready=!1,this.showing=!1,this.timeout=!1,this.tooltipping=!1,this.viewed=!1,this.viewing=!1,this.wheeling=!1,this.zooming=!1,this.init()}init(){const{element:e,options:t}=this;if(e[NAMESPACE])return;e[NAMESPACE]=this;const i="img"===e.tagName.toLowerCase(),s=[];if(forEach(i?[e]:e.querySelectorAll("img"),e=>{isFunction(t.filter)?t.filter.call(this,e)&&s.push(e):e.src&&s.push(e)}),this.isImg=i,this.length=s.length,this.images=s,this.initBody(),isUndefined(document.createElement(NAMESPACE).style.transition)&&(t.transition=!1),t.inline){let e=0;const t=()=>{if(e+=1,e===this.length){let e;this.initializing=!1,this.delaying={abort:()=>{clearTimeout(e)}},e=setTimeout(()=>{this.delaying=!1,this.build()},0)}};this.initializing={abort(){forEach(s,e=>{e.complete||removeListener(e,EVENT_LOAD,t)})}},forEach(s,e=>{e.complete?t():addListener(e,EVENT_LOAD,t,{once:!0})})}else addListener(e,EVENT_CLICK,this.onStart=({target:e})=>{"img"!==e.tagName.toLowerCase()||isFunction(t.filter)&&!t.filter.call(this,e)||this.view(this.images.indexOf(e))})}build(){if(this.ready)return;const{element:e,options:t}=this,i=e.parentNode,s=document.createElement("div");s.innerHTML=TEMPLATE;const n=s.querySelector(`.${NAMESPACE}-container`),a=n.querySelector(`.${NAMESPACE}-title`),r=n.querySelector(`.${NAMESPACE}-toolbar`),o=n.querySelector(`.${NAMESPACE}-navbar`),l=n.querySelector(`.${NAMESPACE}-button`),d=n.querySelector(`.${NAMESPACE}-canvas`);if(this.parent=i,this.viewer=n,this.title=a,this.toolbar=r,this.navbar=o,this.button=l,this.canvas=d,this.footer=n.querySelector(`.${NAMESPACE}-footer`),this.tooltipBox=n.querySelector(`.${NAMESPACE}-tooltip`),this.player=n.querySelector(`.${NAMESPACE}-player`),this.list=n.querySelector(`.${NAMESPACE}-list`),addClass(a,t.title?getResponsiveClass(Array.isArray(t.title)?t.title[0]:t.title):CLASS_HIDE),addClass(o,t.navbar?getResponsiveClass(t.navbar):CLASS_HIDE),toggleClass(l,CLASS_HIDE,!t.button),t.backdrop&&(addClass(n,NAMESPACE+"-backdrop"),t.inline||"static"===t.backdrop||setData(d,DATA_ACTION,"hide")),isString(t.className)&&t.className&&t.className.split(REGEXP_SPACES).forEach(e=>{addClass(n,e)}),t.toolbar){const e=document.createElement("ul"),i=isPlainObject(t.toolbar),s=BUTTONS.slice(0,3),n=BUTTONS.slice(7,9),a=BUTTONS.slice(9);i||addClass(r,getResponsiveClass(t.toolbar)),forEach(i?t.toolbar:BUTTONS,(r,o)=>{const l=i&&isPlainObject(r),d=i?hyphenate(o):r,h=l&&!isUndefined(r.show)?r.show:r;if(!h||!t.zoomable&&-1!==s.indexOf(d)||!t.rotatable&&-1!==n.indexOf(d)||!t.scalable&&-1!==a.indexOf(d))return;const E=l&&!isUndefined(r.size)?r.size:r,S=l&&!isUndefined(r.click)?r.click:r,c=document.createElement("li");c.setAttribute("role","button"),addClass(c,`${NAMESPACE}-${d}`),isFunction(S)||setData(c,DATA_ACTION,d),isNumber(h)&&addClass(c,getResponsiveClass(h)),-1!==["small","large"].indexOf(E)?addClass(c,`${NAMESPACE}-${E}`):"play"===d&&addClass(c,NAMESPACE+"-large"),isFunction(S)&&addListener(c,EVENT_CLICK,S),e.appendChild(c)}),r.appendChild(e)}else addClass(r,CLASS_HIDE);if(!t.rotatable){const e=r.querySelectorAll('li[class*="rotate"]');addClass(e,CLASS_INVISIBLE),forEach(e,e=>{r.appendChild(e)})}if(t.inline)addClass(l,CLASS_FULLSCREEN),setStyle(n,{zIndex:t.zIndexInline}),"static"===window.getComputedStyle(i).position&&setStyle(i,{position:"relative"}),i.insertBefore(n,e.nextSibling);else{addClass(l,CLASS_CLOSE),addClass(n,CLASS_FIXED),addClass(n,CLASS_FADE),addClass(n,CLASS_HIDE),setStyle(n,{zIndex:t.zIndex});let{container:i}=t;isString(i)&&(i=e.ownerDocument.querySelector(i)),i||(i=this.body),i.appendChild(n)}t.inline&&(this.render(),this.bind(),this.isShown=!0),this.ready=!0,isFunction(t.ready)&&addListener(e,EVENT_READY,t.ready,{once:!0}),!1!==dispatchEvent(e,EVENT_READY)?this.ready&&t.inline&&this.view(this.index):this.ready=!1}static noConflict(){return window.Viewer=AnotherViewer,Viewer}static setDefaults(e){assign(DEFAULTS,isPlainObject(e)&&e)}}assign(Viewer.prototype,render,events,handlers,methods,others);export default Viewer;